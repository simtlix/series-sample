# Simfinity Project Generator Rules

You are an expert in generating complete Simfinity.js projects using the series-sample as a template. Your role is to create production-ready applications with proper structure, dependencies, and configuration.

## Project Generation Process

### Step 1: Project Setup
1. **Copy Base Structure**: Use series-sample as template
2. **Update Package.json**: Modify name, description, and dependencies
3. **Create Directory Structure**: Ensure all required folders exist
4. **Generate Configuration Files**: Create necessary config files

### Step 2: Type Generation
1. **Generate Types**: Create all type definitions following Simfinity patterns
2. **Create Validators**: Implement field and type validators
3. **Add Controllers**: Implement business logic controllers
4. **Generate Scalars**: Create custom validated scalars
5. **Update Index**: Configure type loading order

### Step 3: Application Configuration
1. **Main Entry Point**: Configure index.js with proper setup
2. **Database Connection**: Set up MongoDB connection
3. **GraphQL Server**: Configure GraphQL endpoint
4. **Middleware**: Add CORS, error handling, etc.

## Project Structure Template

```
project-name/
├── .cursorrules.md                   # Main cursor rules
├── .cursorrules-mermaid.md          # Mermaid diagram rules
├── .cursorrules-project.md          # Project generation rules
├── .env                            # Environment variables
├── .gitignore                      # Git ignore rules
├── package.json                    # Dependencies and scripts (updated with server options)
├── index.js                        # Main application entry (Simfinity server)
├── index.apollo.js                 # Apollo Server implementation
├── index.yoga.js                   # GraphQL Yoga implementation
├── app.yaml                        # Application configuration
├── eslint.config.js                # ESLint configuration
├── README.md                       # Project documentation
├── types/                          # GraphQL type definitions
│   ├── index.js                    # Central type loading
│   ├── scalars.js                  # Custom scalars
│   ├── validators/                 # Validation logic
│   │   ├── customErrors.js         # Custom error classes
│   │   ├── fieldValidators.js      # Field-level validations
│   │   └── typeValidators.js       # Type-level validations
│   ├── controllers/                # Business logic controllers
│   │   └── [typeName]Controller.js
│   └── [typeName].js               # Individual type definitions
├── dataset/                        # Sample data and utilities
│   ├── dataset.js                  # Sample data generation
│   ├── loadDataset.js              # Data loading utilities
│   └── deleteDataset.js            # Data cleanup utilities
├── data/                           # MongoDB data directory
└── node_modules/                   # Dependencies
```

## Package.json Template

```json
{
  "name": "project-name",
  "version": "1.0.0",
  "description": "Project description - created with simfinity.js",
  "type": "module",
  "main": "index.js",
  "scripts": {
    "start": "node index.js",
    "start:apollo": "node index.apollo.js",
    "start:yoga": "node index.yoga.js",
    "dev": "node --watch index.js",
    "lint": "eslint ./",
    "load-data": "node dataset/loadDataset.js",
    "delete-data": "node dataset/deleteDataset.js"
  },
  "author": "Your Name",
  "license": "SEE LICENSE IN LICENSE",
  "repository": {
    "type": "git",
    "url": "https://github.com/yourusername/project-name"
  },
  "dependencies": {
    "@apollo/server": "^4.12.2",
    "@apollo/server-plugin-landing-page-graphql-playground": "^4.0.1",
    "@as-integrations/express5": "^1.1.2",
    "@envelop/core": "^5.3.0",
    "@simtlix/simfinity-js": "^2.0.2",
    "body-parser": "^2.2.0",
    "cors": "^2.8.5",
    "dotenv": "^17.2.2",
    "express": "^5.1.0",
    "graphql": "^16.11.0",
    "graphql-date-scalars": "^0.2.0",
    "graphql-http": "^1.22.4",
    "graphql-yoga": "^5.16.0",
    "mongoose": "^8.18.2",
    "node-fetch": "^3.3.2",
    "ruru": "^2.0.0-beta.24"
  },
  "devDependencies": {
    "eslint": "^9.30.1"
  }
}
```

## Server Implementation Templates

### 1. Default Simfinity Server (index.js)

```javascript
import express from 'express';
import { createHandler } from 'graphql-http/lib/use/express';
import cors from 'cors';
import dotenv from 'dotenv';
import { createYoga } from 'graphql-yoga';
import { ruruHTML } from 'ruru/server';
import * as simfinity from '@simtlix/simfinity-js';

// Load environment variables
dotenv.config();

// Import types (this loads all type definitions)
import './types/index.js';

const app = express();
const PORT = process.env.PORT || 4000;

// Middleware
app.use(cors());
app.use(express.json());

// GraphQL endpoint
app.use('/graphql', createHandler({
  schema: simfinity.getSchema(),
  context: (req) => ({
    // Add any context needed
  })
}));

// GraphQL Playground
app.use('/playground', (req, res) => {
  res.type('text/html');
  res.end(ruruHTML({ endpoint: '/graphql' }));
});

// Health check endpoint
app.get('/health', (req, res) => {
  res.json({ status: 'OK', timestamp: new Date().toISOString() });
});

// Start server
app.listen(PORT, () => {
  console.log(`🚀 Server running on http://localhost:${PORT}`);
  console.log(`📊 GraphQL Playground: http://localhost:${PORT}/playground`);
  console.log(`🔍 GraphQL endpoint: http://localhost:${PORT}/graphql`);
});
```

### 2. Apollo Server Implementation (index.apollo.js)

```javascript
import 'dotenv/config';
import express from 'express';
import cors from 'cors';
import mongoose from 'mongoose';
import { ApolloServer } from '@apollo/server';
import { expressMiddleware } from '@apollo/server/express4';
import * as simfinity from '@simtlix/simfinity-js';

// MongoDB Connection
let mongooseConfig = [
  'mongodb://localhost:27017,localhost:27018,localhost:27019/project-name',
  { replicaSet: 'rs' }
];

if (process.env.MONGO) {
  mongooseConfig = [process.env.MONGO, {}];
}

await mongoose
  .connect(...mongooseConfig)
  .then(() => console.log('Connected to the database'))
  .catch((e) => console.error(e));

// Load Simfinity types + schema
import './types/index.js';
const schema = simfinity.createSchema();

// Error formatting
const formatError = simfinity.buildErrorFormatter((err) => {
  console.error(err);
});

// Apollo Server setup
const server = new ApolloServer({
  schema,
  formatError
});
await server.start();

// Express app setup
const app = express();
app.use(cors());

// GraphQL endpoint
app.use('/graphql', express.json(), expressMiddleware(server, {
  context: async () => ({})
}));

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Listening on port ${PORT}`);
  console.log(`GraphQL endpoint: http://localhost:${PORT}/graphql`);
});
```

### 3. GraphQL Yoga Implementation (index.yoga.js)

```javascript
import 'dotenv/config';
import express from 'express';
import cors from 'cors';
import mongoose from 'mongoose';
import { createYoga } from 'graphql-yoga';
import * as simfinity from '@simtlix/simfinity-js';
import { useErrorHandler } from '@envelop/core';

// MongoDB Connection
let mongooseConfig = [
  'mongodb://localhost:27017,localhost:27018,localhost:27019/project-name',
  { replicaSet: 'rs' }
];

if (process.env.MONGO) {
  mongooseConfig = [process.env.MONGO, {}];
}

mongoose
  .connect(...mongooseConfig)
  .then(() => console.log('Connected to the database'))
  .catch((e) => console.error(e));

// Load Simfinity types + schema
import './types/index.js';
const schema = simfinity.createSchema();

// Custom Envelop plugins
function useTimingPlugin() {
  return {
    onExecute() {
      const start = Date.now();
      return {
        onExecuteDone({ result }) {
          const durationMs = Date.now() - start;
          result.extensions = {
            ...result.extensions,
            runTime: durationMs,
            timestamp: new Date().toISOString()
          };
        }
      };
    }
  };
}

function useCountPlugin() {
  return {
    onExecute() {
      return {
        onExecuteDone({ result, args }) {
          if (args.contextValue?.count) {
            result.extensions = {
              ...result.extensions,
              count: args.contextValue.count
            };
          }
        }
      };
    }
  };
}

// Express + Yoga setup
const app = express();
app.use(cors());

const yoga = createYoga({
  schema,
  plugins: [
    useErrorHandler(
      simfinity.buildErrorFormatter((err) => {
        console.error(err);
      })
    ),
    useTimingPlugin(),
    useCountPlugin()
  ],
  graphiql: true,
  graphqlEndpoint: '/graphql',
  maskedErrors: false
});

app.use('/graphql', yoga);

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Listening on port ${PORT}`);
  console.log(`GraphQL endpoint: http://localhost:${PORT}/graphql`);
});
```

## Environment Configuration (.env)

```env
# Database Configuration
MONGODB_URI=mongodb://localhost:27017/project-name
MONGODB_DB_NAME=project-name

# Server Configuration
PORT=4000
NODE_ENV=development

# Application Configuration
APP_NAME=Project Name
APP_VERSION=1.0.0
```

## Type Index Template (types/index.js)

```javascript
// Types index - centralized type loading
// Load types in dependency order to avoid circular dependency issues

// Load custom scalars first
import './scalars.js';

// Independent types first (no dependencies)
// Add your independent types here

// Types that depend on the above
// Add dependent types here

// Main types that reference others
// Add main types here

// Re-export types if needed
// Add exports here
```

## Scalars Template (types/scalars.js)

```javascript
import * as graphql from 'graphql';
import * as simfinity from '@simtlix/simfinity-js';
import { ValidationError } from './validators/customErrors.js';

const { GraphQLString, GraphQLInt, GraphQLFloat } = graphql;

// Add your custom scalars here
// Example:
// export const CustomScalar = simfinity.createValidatedScalar(
//   'CustomScalar',
//   'Description of the scalar validation',
//   GraphQLString,
//   (value) => {
//     // Validation logic
//     return value;
//   }
// );
```

## Validators Template

### Custom Errors (types/validators/customErrors.js)
```javascript
import { SimfinityError } from '@simtlix/simfinity-js';

// Validation Errors
class ValidationError extends SimfinityError {
  constructor(message) {
    super(message, 'VALIDATION_ERROR', 400);
  }
}

// Business Logic Errors
class BusinessError extends SimfinityError {
  constructor(message) {
    super(message, 'BUSINESS_ERROR', 400);
  }
}

// Authorization Errors
class AuthorizationError extends SimfinityError {
  constructor(message) {
    super(message, 'UNAUTHORIZED', 401);
  }
}

// Not Found Errors
class NotFoundError extends SimfinityError {
  constructor(message) {
    super(message, 'NOT_FOUND', 404);
  }
}

// Conflict Errors
class ConflictError extends SimfinityError {
  constructor(message) {
    super(message, 'CONFLICT', 409);
  }
}

export {
  ValidationError,
  BusinessError,
  AuthorizationError,
  NotFoundError,
  ConflictError
};
```

### Field Validators (types/validators/fieldValidators.js)
```javascript
import { ValidationError } from './customErrors.js';

// Name validators
const validateName = async (typeName, fieldName, value, session) => {
  if (!value || value.trim().length === 0) {
    throw new ValidationError(`${fieldName} cannot be empty`);
  }
  if (value.trim().length < 2) {
    throw new ValidationError(`${fieldName} must be at least 2 characters long`);
  }
  if (value.trim().length > 100) {
    throw new ValidationError(`${fieldName} cannot exceed 100 characters`);
  }
};

// Email validators
const validateEmail = async (typeName, fieldName, value, session) => {
  if (value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
    throw new ValidationError(`${fieldName} must be a valid email address`);
  }
};

// Number validators
const validatePositiveNumber = async (typeName, fieldName, value, session) => {
  if (value !== undefined && value !== null) {
    if (typeof value !== 'number' || value <= 0) {
      throw new ValidationError(`${fieldName} must be a positive number`);
    }
  }
};

// Add more validators as needed

export {
  validateName,
  validateEmail,
  validatePositiveNumber
  // Add more exports
};
```

### Type Validators (types/validators/typeValidators.js)
```javascript
import { BusinessError } from './customErrors.js';

// Add your type-level business rule validators here
// Example:
// const validateTypeBusinessRules = async (typeName, args, modelArgs, session) => {
//   // Business logic validation
// };

export {
  // Add your exports here
};
```

## ESLint Configuration (eslint.config.js)

```javascript
export default [
  {
    languageOptions: {
      ecmaVersion: 2022,
      sourceType: 'module',
      globals: {
        console: 'readonly',
        process: 'readonly',
        Buffer: 'readonly',
        __dirname: 'readonly',
        __filename: 'readonly',
        global: 'readonly',
        module: 'readonly',
        require: 'readonly',
        exports: 'readonly'
      }
    },
    rules: {
      'no-unused-vars': 'warn',
      'no-console': 'off',
      'prefer-const': 'error',
      'no-var': 'error'
    }
  }
];
```

## Application Configuration (app.yaml)

```yaml
name: project-name
version: 1.0.0
description: Project description
author: Your Name
license: MIT
repository: https://github.com/yourusername/project-name
dependencies:
  - @simtlix/simfinity-js
  - graphql
  - express
  - mongoose
```

## README Template

```markdown
# Project Name

Project description created with Simfinity.js

## Features

- GraphQL API with Simfinity.js
- MongoDB database
- Type validation and business rules
- State machines for complex workflows
- Custom scalars and validators
- Multiple server implementations (Simfinity, Apollo, Yoga)

## Setup

1. Install dependencies:
   ```bash
   npm install
   ```

2. Set up environment variables:
   ```bash
   cp .env.example .env
   # Edit .env with your configuration
   ```

3. Start MongoDB:
   ```bash
   # Make sure MongoDB is running on localhost:27017
   ```

4. Load sample data (optional):
   ```bash
   npm run load-data
   ```

## Starting the Server

### GraphQL Server Options

The project includes three different GraphQL server implementations:

#### 1. Default Simfinity Server (Recommended)
```bash
npm start
```
Uses the main `index.js` with Simfinity.js built-in HTTP layer and GraphQL server.

#### 2. Apollo Server Implementation
```bash
npm run start:apollo
```
Runs with `index.apollo.js` using `@apollo/server` for advanced features like:
- Advanced playground integration
- Plugins for metrics and monitoring
- Apollo-specific features and optimizations

#### 3. GraphQL Yoga Implementation
```bash
npm run start:yoga
```
Runs with `index.yoga.js` using `graphql-yoga` for:
- Modern GraphQL developer experience
- Enhanced debugging capabilities
- Built-in timing and count extensions
- Advanced error handling with Envelop plugins

## API Endpoints

- GraphQL: http://localhost:3000/graphql (all servers)
- Simfinity Playground: http://localhost:4000/playground (default server only)
- Health Check: http://localhost:4000/health (when implemented)

## Development

- Default server: `npm start`
- Apollo server: `npm run start:apollo`
- Yoga server: `npm run start:yoga`
- Watch mode: `npm run dev`
- Lint code: `npm run lint`
- Delete all data: `npm run delete-data`

## Environment Variables

All servers support:
```bash
# Custom MongoDB connection string
MONGO=mongodb://localhost:27017/project-custom npm start

# Custom port
PORT=4000 npm start
```

### Debug Configuration

All servers support debugging with async stack traces:

#### Debug Default Server
```bash
node --inspect=0.0.0.0:9229 --async-stack-traces index.js
```

#### Debug Apollo Server
```bash
node --inspect=0.0.0.0:9229 --async-stack-traces index.apollo.js
```

#### Debug Yoga Server
```bash
node --inspect=0.0.0.0:9229 --async-stack-traces index.yoga.js
```

Create `.vscode/launch.json` for debugging:
```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Debug Simfinity Server",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/index.js",
      "runtimeArgs": ["--inspect=0.0.0.0:9229", "--async-stack-traces"]
    },
    {
      "name": "Debug Apollo Server",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/index.apollo.js",
      "runtimeArgs": ["--inspect=0.0.0.0:9229", "--async-stack-traces"]
    },
    {
      "name": "Debug Yoga Server",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/index.yoga.js",
      "runtimeArgs": ["--inspect=0.0.0.0:9229", "--async-stack-traces"]
    }
  ]
}
```

## License

MIT
```

## Generation Commands

### Generate Complete Project
```
Generate a complete Simfinity.js project for [description] using series-sample as template
```

### Generate Types from Mermaid
```
Generate Simfinity.js types from this Mermaid diagram: [diagram]
```

### Generate Single Type
```
Generate a [typeName] type with fields [fieldList] and relations [relationList]
```

### Generate Validators
```
Generate validators for [typeName] with business rules [rules]
```

### Generate Controller
```
Generate controller for [typeName] with business logic [logic]
```

## Best Practices

1. **Always use series-sample as template**: Ensure compatibility
2. **Follow naming conventions**: camelCase for fields, PascalCase for types
3. **Include proper validations**: Field and type-level validations
4. **Add business logic**: Controllers for complex operations
5. **Document everything**: Clear comments and README
6. **Test thoroughly**: Include sample data and test scenarios
7. **Handle errors gracefully**: Proper error handling and messages
8. **Follow Simfinity patterns**: Use exact patterns from series-sample

Remember: Always generate production-ready code that follows Simfinity.js patterns exactly as shown in the series-sample project.
